# Side Panel & Query History

## Context/Background

- Current popup disappears when user accidentally clicks outside, losing all form state
- No way to access previously generated queries
- No theme customization (relies on hardcoded styles)

## AS-IS (Before v2.3.1)

1. Extension opens as popup - disappears when clicking outside
2. All query state is lost when popup closes
3. No query history storage
4. No theme support (single hardcoded style)
5. Time validation only occurs when clicking "Generate Query"

## TO-BE (v2.3.1 Implementation)

1. Extension opens as Side Panel - stays open until explicitly closed
2. Query history stored (up to 10 entries) with full configuration + generated SQL
3. Auto-restore last query if within 24 hours
4. Theme follows system preference with manual toggle override
5. Time validation triggers on blur (when leaving time input fields)

## Implementation Details

### Side Panel Architecture

#### Manifest Changes

```json
{
  "permissions": ["clipboardWrite", "sidePanel"],
  "side_panel": {
    "default_path": "sidepanel.html"
  },
  "background": {
    "service_worker": "background.js"
  }
}
```

#### Background Service Worker

Handles extension icon click to open side panel:

```javascript
chrome.sidePanel.setPanelBehavior({ openPanelOnActionClick: true });
```

#### Behavior

| Aspect | Behavior |
|--------|----------|
| Open trigger | Click extension icon |
| Persistence | Stays open when clicking elsewhere on page |
| Tab switching | Same panel instance persists across tabs |
| Close | Click X button or extension icon again |

### Query History Storage

#### Storage Structure (localStorage)

```javascript
{
  id: 'history_1234567890',
  createdAt: 1234567890,
  config: {
    queryType: 'standard' | 'distinct',
    tableName: 'imp_join_all2',
    fieldRows: [...],
    conditionRows: [...],
    timeStart: '2025-01-01',
    timeEnd: '2025-01-15',
    timezone: '+08:00'
  },
  generatedSql: 'SELECT ...'
}
```

#### History Management Rules

| Rule | Behavior |
|------|----------|
| Max entries | 10 (oldest auto-removed when limit reached) |
| When saved | Automatically after each "Generate Query" |
| Deduplication | If same config exists, update timestamp instead of duplicate |

#### HistoryManager Class Methods

| Method | Description |
|--------|-------------|
| `save(config, sql)` | Add entry, enforce 10-item limit |
| `getAll()` | Return all entries, newest first |
| `getLatest()` | Return most recent entry |
| `getById(id)` | Get specific entry |
| `delete(id)` | Remove entry |
| `clear()` | Remove all entries |

### Auto-Restore Behavior

#### On Panel Open

```
1. Get latest history entry
2. If entry exists AND createdAt is within 24 hours:
   → Auto-populate form with saved config
   → Show restore indicator banner
3. Else:
   → Start with empty form
```

#### Restore Indicator Banner

```
┌─────────────────────────────────────────┐
│ ↩ Restored from 2 hours ago    [Clear] │
└─────────────────────────────────────────┘
```

- "Clear" button resets form to empty state
- Banner auto-hides after 5 seconds or on user interaction

#### History UI Section

Collapsible section below query output:

```
▼ History (3)
┌─────────────────────────────────────────┐
│ imp_join_all2 - 2 hours ago      [Load] │
│ creative_event - yesterday       [Load] │
│ imp_join_all2 - 2 days ago       [Load] │
└─────────────────────────────────────────┘
```

Each entry shows: table name, relative time, Load button.

### Theme System

#### Theme Detection Priority

1. Check `localStorage` for saved preference (`spark_helper_theme`)
2. If no saved preference → use system preference via `prefers-color-scheme`
3. Apply theme via `data-theme` attribute on `<html>`

#### Theme Toggle

Located in panel header (top-right corner):

```
┌──────────────────────────────────────────┐
│ Appier Spark Helper              [☀/☾] │
└──────────────────────────────────────────┘
```

- Click toggles between light/dark
- Saves preference to `localStorage`
- Once manually set, overrides system preference

#### CSS Implementation

```css
:root {
  --bg-primary: #ffffff;
  --text-primary: #1a1a1a;
}

[data-theme="dark"] {
  --bg-primary: #1a1a1a;
  --text-primary: #e0e0e0;
}

@media (prefers-color-scheme: dark) {
  :root:not([data-theme="light"]) {
    --bg-primary: #1a1a1a;
    --text-primary: #e0e0e0;
  }
}
```

### Time Validation on Blur

Time range validation now triggers when the user leaves (blur) the time input fields, not just when clicking "Generate Query".

#### Behavior

| Event | Action |
|-------|--------|
| User leaves start/end time input | Validate time range immediately |
| Both fields empty | No validation (no error shown) |
| At least one field has value | Run full validation |
| Invalid format or range | Show error message below inputs |

#### Error Message Layout Fix

Error messages now properly wrap below the input fields without blocking user interaction:

```css
.form-group {
  flex-wrap: wrap;  /* Allow error to wrap to new line */
}

.error-message {
  order: 99;  /* Push error to end of flex container */
}
```

## Files Changed

| File | Changes |
|------|---------|
| `manifest.json` | Add `sidePanel` permission, `side_panel` config, `background` service worker |
| `background.js` | **NEW** - Handle icon click → open side panel |
| `popup.html` → `sidepanel.html` | Rename, add theme toggle button, add history section |
| `src/js/historyManager.js` | **NEW** - History CRUD, 10-item limit, deduplication |
| `src/js/themeManager.js` | **NEW** - Theme detection, toggle, persistence |
| `src/js/app.js` | Init history/theme managers, auto-restore logic, wire history UI, time blur validation |
| `src/js/ui.js` | Add `loadHistoryConfig()`, `resetForm()` methods |
| `src/css/styles.css` | CSS variables for theming, history section styles, restore banner styles, error message layout fix |
