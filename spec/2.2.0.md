# Enhanced WHERE Clause & User Snippets

## Context/Background

- Users need more flexible WHERE clause filtering beyond predefined templates
- Currently, WHERE conditions are template-based only (predefined SQL or custom raw SQL)
- No way to save frequently used queries for reuse with different time ranges
- All query state is lost when popup closes

## AS-IS (Before v2.2.0)

1. WHERE conditions are template-based (dropdown with predefined conditions or custom SQL)
2. No operator selection (=, IN, NOT IN) for field-value filtering
3. No ability to save/reuse queries
4. Quick Query only has predefined templates, no user snippets
5. No validation that end time is greater than start time

## TO-BE (v2.2.0 Implementation)

1. New field-based WHERE conditions with field autocomplete + operator selection
2. Operators: `=`, `IN`, `NOT IN` with multi-value input for IN/NOT IN
3. User can save current query as a reusable snippet (excluding time range)
4. Quick Access section with tabs: "Templates" (existing) and "Saved Snippets" (new)
5. Time range validation ensures end time > start time

## Implementation Details

### Enhanced WHERE Clause

#### Condition Types

| Type | Description |
|------|-------------|
| **Field Condition** | Field autocomplete + operator + value(s) |
| **Template** | Existing predefined conditions or custom SQL |

#### Field Condition Row Structure

```
[Field Autocomplete] [Operator ▼] [Value Input] [×]
                                  or
                     [Multi-line Textarea for IN/NOT IN]
```

#### Operator Behavior

| Operator | Input Type | SQL Output |
|----------|------------|------------|
| `=` | Single text input | `field = 'value'` |
| `IN` | Multi-line textarea | `field IN ('val1', 'val2', ...)` |
| `NOT IN` | Multi-line textarea | `field NOT IN ('val1', 'val2', ...)` |

#### Binary Field Handling

Binary fields in WHERE automatically wrapped with `BYTES2STR()`:

```sql
-- For binary field 'cid' with operator =
BYTES2STR(cid) = 'value'

-- For binary field 'cid' with operator IN
BYTES2STR(cid) IN ('val1', 'val2')
```

#### SQL String Escaping

Single quotes in values are escaped as `''` to prevent SQL injection:

```sql
-- Input: O'Brien
-- Output: field = 'O''Brien'
```

### User-Saved Snippets

#### Quick Access Section (Renamed from "Quick Query")

Two tabs:

- **Templates**: Existing predefined query templates
- **Saved Snippets**: User-saved queries

#### Snippet Storage (localStorage)

```javascript
{
  id: 'snippet_1234567890',
  name: 'My Query',
  createdAt: 1234567890,
  queryType: 'standard' | 'distinct',
  tableName: 'imp_join_all2',
  fieldRows: [...],      // SELECT fields
  conditionRows: [...],  // WHERE conditions
  preview: 'SELECT\n...' // First 100 chars
}
```

#### Snippet Workflow

1. Build query in Standard/Distinct mode
2. Click "Save as Snippet" -> enter name
3. Switch to Quick Query mode -> Saved Snippets tab
4. Select snippet + enter time range -> Generate
5. SQL generated with saved config + new time

#### Snippet Management

- **Rename**: Click "Rename" button, enter new name
- **Delete**: Click "Delete" button, confirm deletion

### Time Range Validation

Enhanced validation for time inputs in all query modes:

| Validation | Error Message |
|------------|---------------|
| Missing start/end time | "Please enter start and end time" |
| Invalid start time format | "Invalid start time format (use YYYY-MM-DD or YYYY-MM-DD-HH)" |
| Invalid end time format | "Invalid end time format (use YYYY-MM-DD or YYYY-MM-DD-HH)" |
| End time <= start time | "End time must be greater than start time" |

### UI Changes

#### WHERE Section

Before:

```
[+Add condition]
```

After:

```
[+Field Condition] [+Template]
```

#### Actions Section

Before:

```
[Generate Query] [Copy to Clipboard]
```

After:

```
[Generate Query] [Copy to Clipboard] [Save as Snippet]
```

Note: "Save as Snippet" button is hidden in Quick Query mode.

## Files Changed

| File | Changes |
|------|---------|
| `popup.html` | WHERE dual buttons, Quick Access tabs, snippet UI, save button |
| `src/js/snippetManager.js` | **NEW** - snippet CRUD with localStorage |
| `src/js/ui.js` | `addFieldConditionRow()`, `getConditionRowsData()` refactor, snippet UI methods |
| `src/js/queryBuilder.js` | `buildWherePart()` for field conditions, `escapeSqlString()`, `validateTimeRange()` |
| `src/js/app.js` | Field condition wiring, snippet manager init, tab/save logic, time range validation |
| `src/css/styles.css` | WHERE field row, tabs, snippet preview styling |
