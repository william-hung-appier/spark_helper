# JOIN Feature for Cross-Table Queries

## Context/Background

- Users unfamiliar with Spark SQL need help writing JOIN queries between tables
- Current extension only supports single-table queries (Standard, Distinct, Quick Query modes)
- Cross-table analysis is a common use case (e.g., joining `imp_join_all2` with `creative_event`)
- Visual aids (Venn diagrams) can help users understand different JOIN types
- Tables share common join keys like `cid`, `oid`, `campaign_id`

## AS-IS (Before v2.4.0)

1. Extension only supports querying one table at a time
2. No way to combine data from multiple tables
3. Users must manually write JOIN syntax if needed
4. No educational content about JOIN types
5. SELECT field picker only shows fields from single selected table

## TO-BE (v2.4.0 Implementation)

1. Standard mode extended with optional "Join with another table" feature
2. Support for INNER JOIN, LEFT OUTER JOIN, FULL OUTER JOIN
3. Visual info modal with Venn diagrams explaining each JOIN type
4. Two separate SELECT field sections when JOIN is enabled (one per table)
5. Smart suggestions for common join keys between table pairs
6. Generated SQL uses proper table aliases (t1, t2) and prefixes

## Scope

### In Scope

- Cross-table joins between any two of the 4 supported tables
- Three join types: INNER JOIN, LEFT OUTER JOIN, FULL OUTER JOIN
- Single join key condition (field1 = field2)
- Info modal with Venn diagram visualizations
- Common join key suggestions
- Shared time range for both tables

### Out of Scope (Future Versions)

- Multiple join conditions (AND)
- Joining more than 2 tables
- RIGHT OUTER JOIN (can use LEFT with swapped tables)
- CROSS JOIN
- Custom table joins
- Different time ranges per table

## Acceptance Criteria

### JOIN Toggle

- [ ] "Join with another table" checkbox appears below table selector
- [ ] Checkbox is disabled until first table is selected
- [ ] Enabling checkbox reveals JOIN configuration section
- [ ] Disabling checkbox clears JOIN config and reverts to single-table mode

### JOIN Configuration

- [ ] Join Type dropdown with: INNER JOIN, LEFT OUTER JOIN, FULL OUTER JOIN
- [ ] "?" info button opens modal with Venn diagrams
- [ ] Second table dropdown excludes already-selected first table
- [ ] ON clause: two field dropdowns for join condition
- [ ] Common join keys appear first in ON field dropdowns with "Suggested" label

### SELECT Section (JOIN Mode)

- [ ] Section splits into two sub-sections: "[Table1] (t1)" and "[Table2] (t2)"
- [ ] Each sub-section has its own "+Add field" button
- [ ] Fields from each table only appear in their respective autocomplete
- [ ] At least one field must be selected from either table to generate query

### WHERE Section (JOIN Mode)

- [ ] Field condition autocomplete shows fields from both tables
- [ ] Fields prefixed with table indicator (t1. or t2.)
- [ ] Template conditions still work as before

### Generated SQL

- [ ] Uses table aliases t1 and t2
- [ ] SELECT fields prefixed with correct alias
- [ ] FROM clause: `table1_timerange t1`
- [ ] JOIN clause: `{JOIN_TYPE} table2_timerange t2`
- [ ] ON clause: `ON t1.field = t2.field`
- [ ] WHERE conditions use proper prefixes
- [ ] Time range applies to both tables

### Info Modal

- [ ] Opens when clicking "?" button
- [ ] Shows Venn diagrams for all three JOIN types
- [ ] Includes plain-English explanation for each type
- [ ] Includes practical example
- [ ] Closes via X button, clicking outside, or Escape key
- [ ] Styled for both light and dark themes

### History & Snippets

- [ ] JOIN queries saved to history with join config
- [ ] JOIN queries can be saved as snippets
- [ ] Loading history/snippet restores JOIN configuration

## Implementation Notes

### UI Layout

**FROM Section (with JOIN enabled):**

```
┌─────────────────────────────────────────────────────────┐
│ FROM                                                    │
├─────────────────────────────────────────────────────────┤
│ Table: [imp_join_all2          ▼]                       │
│                                                         │
│ ☑ Join with another table                               │
│ ┌─────────────────────────────────────────────────────┐ │
│ │ Join Type: [INNER JOIN ▼] [?]                       │ │
│ │ Table:     [creative_event   ▼]                     │ │
│ │ ON:        [t1.cid ▼] = [t2.cid ▼]                  │ │
│ └─────────────────────────────────────────────────────┘ │
│                                                         │
│ Time: [2025-01-01-00] to [2025-01-02-00]               │
│ Timezone: [UTC +8 ▼]                                    │
└─────────────────────────────────────────────────────────┘
```

**SELECT Section (with JOIN enabled):**

```
┌─────────────────────────────────────────────────────────┐
│ SELECT                                                  │
├─────────────────────────────────────────────────────────┤
│ ┌─ imp_join_all2 (t1) ────────────────────────────────┐ │
│ │ [cid                    ▼] [×]                      │ │
│ │ [oid                    ▼] [×]                      │ │
│ │ [+Add field]                                        │ │
│ └─────────────────────────────────────────────────────┘ │
│ ┌─ creative_event (t2) ───────────────────────────────┐ │
│ │ [type                   ▼] [×]                      │ │
│ │ [+Add field]                                        │ │
│ └─────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
```

### Generated SQL Example

```sql
SELECT
  t1.cid AS cid,
  t1.oid AS oid,
  t2.type AS type
FROM
  imp_join_all2_2025010100_2025010200 t1
INNER JOIN
  creative_event_2025010100_2025010200 t2
ON t1.cid = t2.cid
```

### Common Join Keys

| Table Pair | Suggested Keys |
|------------|----------------|
| imp_join_all2 ↔ creative_event | `cid`, `oid`, `campaign_id` |
| imp_join_all2 ↔ creative_perf_event | `cid`, `oid`, `campaign_id` |
| imp_join_all2 ↔ creative_quality | `cid`, `oid` |
| creative_event ↔ creative_perf_event | `cid`, `type` |
| creative_event ↔ creative_quality | `cid` |
| creative_perf_event ↔ creative_quality | `cid` |

### State Structure

```javascript
// AppState additions
joinConfig: {
  enabled: false,
  joinType: 'INNER JOIN',  // 'LEFT OUTER JOIN', 'FULL OUTER JOIN'
  table2: null,
  onField1: null,  // Field from table 1
  onField2: null   // Field from table 2
}
```

### Files Changed

| File | Changes |
|------|---------|
| `sidepanel.html` | JOIN checkbox, join config section, dual SELECT sections, modal HTML |
| `src/js/state.js` | Add `joinConfig` state object and methods |
| `src/js/joinKeys.js` | **NEW** - Common join key definitions |
| `src/js/queryBuilder.js` | New `buildJoinClause()` and `generateJoinQuery()` methods |
| `src/js/ui.js` | `renderJoinSection()`, `renderDualSelectSections()`, `showJoinInfoModal()` |
| `src/js/app.js` | Wire JOIN toggle, second table selection, ON field dropdowns |
| `src/js/historyManager.js` | Include joinConfig in history entries |
| `src/js/snippetManager.js` | Include joinConfig in snippet storage |
| `src/css/styles.css` | JOIN section styles, modal styles, dual SELECT box styling |

### Info Modal Content

```
┌─────────────────────────────────────────────────────────┐
│ Understanding JOIN Types                          [×]   │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  INNER JOIN              LEFT OUTER JOIN                │
│  ┌───────────────┐       ┌───────────────┐              │
│  │ (A)  ███  (B) │       │ ███████  (B) │              │
│  │      ███      │       │ ███████      │              │
│  └───────────────┘       └───────────────┘              │
│  Only matching rows      All from left table,           │
│  from both tables        matches from right             │
│                                                         │
│  FULL OUTER JOIN                                        │
│  ┌───────────────┐                                      │
│  │ ███████████   │                                      │
│  │ ███████████   │                                      │
│  └───────────────┘                                      │
│  All rows from both                                     │
│  tables, NULL where                                     │
│  no match                                               │
│                                                         │
├─────────────────────────────────────────────────────────┤
│ Example: Joining orders with customers                  │
│ • INNER: Only orders that have a customer               │
│ • LEFT:  All orders, customer info if exists            │
│ • FULL:  All orders + all customers                     │
└─────────────────────────────────────────────────────────┘
```

- Venn diagrams implemented as inline SVG
- Modal follows current theme (light/dark)
- Closes via X button, clicking outside modal, or pressing Escape
