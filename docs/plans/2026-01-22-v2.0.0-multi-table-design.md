# Spark Helper v2.0.0 Design Document

## Overview

This document describes the design for v2.0.0 of the Spark Helper Chrome extension, focusing on multi-table support and improved UX with searchable field selection.

## Key Changes from v1.1.3

| Aspect | v1.1.3 | v2.0.0 |
|--------|--------|--------|
| Tables supported | 1 (imp_join_all2) | 4 tables + custom |
| Schema source | HTML web scraping | Bundled YAML → JS |
| Field selection | Static dropdown | Autocomplete with debounce |
| UI flow | SELECT → FROM | FROM → SELECT |
| Field mappings | Single file | Per-table files |
| Binary fields | Shown in dropdown | Auto-wrapped silently |

## Supported Tables

1. `imp_join_all2` - AD session logs (230 fields)
2. `creative_event` - Creative events (25 fields)
3. `creative_perf_event` - Performance events (8 fields)
4. `creative_quality` - Quality metrics (8 fields)
5. Custom tables (user-typed, no field suggestions)

## Design Decisions

### 1. Nested Field Display
- **Decision:** Flatten with dot notation
- **Example:** `actions.action_id`, `actions.action_time`

### 2. Custom Field Mappings Structure
- **Decision:** Separate files per table
- **Location:** `src/js/mappings/{table_name}.js`

### 3. Field Selection UI
- **Decision:** Autocomplete/combobox pattern
- **Behavior:** Type to search, suggestions appear with 250ms debounce

### 4. WHERE Conditions
- **Decision:** Each table has its own predefined conditions
- **Location:** Defined in each mapping file

### 5. Schema Loading
- **Decision:** Bundle as JS objects (build step)
- **Process:** YAML → JS conversion via `scripts/generate-schemas.js`

### 6. Binary Field Handling
- **Decision:** Auto-wrap silently
- **Behavior:** User sees `req_id`, SQL generates `BYTES2STR(req_id)`

### 7. Table Selection
- **Decision:** Autocomplete allowing custom table names
- **Behavior:** Known tables have suggestions, custom tables have no field hints

## File Structure

```
spark_helper/
├── src/
│   ├── js/
│   │   ├── app.js              # Updated: table selection flow
│   │   ├── state.js            # Updated: add selectedTable
│   │   ├── queryBuilder.js     # Updated: binary auto-wrap
│   │   ├── ui.js               # Major: autocomplete component
│   │   ├── schemaParser.js     # Rewritten: load bundled schemas
│   │   ├── mappings/           # NEW
│   │   │   ├── index.js
│   │   │   ├── imp_join_all2.js
│   │   │   ├── creative_event.js
│   │   │   ├── creative_perf_event.js
│   │   │   └── creative_quality.js
│   │   └── schemas/            # NEW (generated)
│   │       ├── index.js
│   │       ├── imp_join_all2.js
│   │       ├── creative_event.js
│   │       ├── creative_perf_event.js
│   │       └── creative_quality.js
│   └── css/
│       └── styles.css          # Updated: autocomplete styles
├── scripts/                    # NEW
│   └── generate-schemas.js
├── Makefile                    # Updated
├── popup.html                  # Updated: reordered sections
└── ...

Files to DELETE:
- src/js/defaultSchema.js
- src/js/fieldMappings.js
```

## UI Flow

```
┌─────────────────────────────────────┐
│  FROM Section (moved to top)        │
│  ┌─────────────────────────────┐    │
│  │ Table: [autocomplete input] │    │
│  └─────────────────────────────┘    │
│  Time: [start] to [end]             │
│  Timezone: [dropdown]               │
└─────────────────────────────────────┘
            ↓ (table selected)
┌─────────────────────────────────────┐
│  SELECT Section                     │
│  ┌─────────────────────────────┐    │
│  │ [autocomplete] AS [alias]  ×│    │
│  └─────────────────────────────┘    │
│  + Add field                        │
└─────────────────────────────────────┘
            ↓
┌─────────────────────────────────────┐
│  WHERE Section                      │
│  [condition dropdown] [value]       │
│  + Add condition                    │
└─────────────────────────────────────┘
            ↓
┌─────────────────────────────────────┐
│  [Generate Query] [Copy]            │
│  ┌─────────────────────────────┐    │
│  │ SELECT ...                  │    │
│  │ FROM ...                    │    │
│  └─────────────────────────────┘    │
└─────────────────────────────────────┘
```

## Autocomplete Component

```javascript
class Autocomplete {
  constructor(container, options) {
    this.input = container.querySelector('input');
    this.dropdown = container.querySelector('.autocomplete-dropdown');
    this.items = options.items;           // [{value, label, type?}]
    this.onSelect = options.onSelect;     // Callback
    this.debounceMs = options.debounce || 250;
    this.matchMode = 'startsWith';        // Case-insensitive prefix
  }

  filter(query) { ... }
  render(matches) { ... }
  handleKeyboard(e) { ... }
}
```

## Schema Generation

**Input:** `schemas/spark/{table}.yaml`
```yaml
schema:
  fields:
    - name: req_id
      type: binary
    - name: actions
      type: array
      elementType:
        fields:
          - name: action_id
            type: string
```

**Output:** `src/js/schemas/{table}.js`
```javascript
const IMP_JOIN_ALL2_SCHEMA = {
  name: "imp_join_all2",
  fields: [
    { name: "req_id", type: "binary" },
    { name: "actions.action_id", type: "string" },
    // ... flattened fields
  ]
};
```

## Mapping File Structure

```javascript
// src/js/mappings/imp_join_all2.js
const IMP_JOIN_ALL2_MAPPINGS = {
  fields: {
    oid: { sql: "CID2OID(cid)", alias: "oid" },
    cid: { sql: "cid", alias: "cid" },
    bidobjid: { sql: "BYTES2STR(bid_appier_id)", alias: "bidobjid" },
    // ...
  },
  conditions: {
    bid_win: {
      label: "Win Bid (RTB)",
      sql: "is_external IS NULL AND win_time IS NOT NULL"
    },
    // ...
  }
};
```

## Binary Field Auto-Wrapping

In QueryBuilder:
```javascript
buildSelectPart(fieldData) {
  const fieldName = fieldData.fieldName;
  const alias = fieldData.alias || fieldName;

  // Check if binary field
  if (schemaParser.isBinaryField(this.tableName, fieldName)) {
    return `  BYTES2STR(${fieldName}) AS ${alias}`;
  }

  return `  ${fieldName} AS ${alias}`;
}
```

## Makefile Commands

```makefile
update-spark-schema:
	git submodule update --remote schemas
	node scripts/generate-schemas.js
	@echo "Schemas updated successfully"

setup:
	git submodule init
	git submodule update
	node scripts/generate-schemas.js
```

## Implementation Order

1. Create schema generation script
2. Create mapping files structure
3. Rewrite SchemaParser for bundled schemas
4. Update AppState with selectedTable
5. Build Autocomplete component
6. Update UIManager with autocomplete integration
7. Reorder popup.html (FROM before SELECT)
8. Update QueryBuilder for binary auto-wrap
9. Update styles.css for autocomplete
10. Update documentation (README, CLAUDE.md)
11. Update manifest.json to v2.0.0

## Testing Checklist

- [ ] Schema generation works for all 4 tables
- [ ] Table autocomplete shows suggestions
- [ ] Custom table name works (no suggestions)
- [ ] Field autocomplete filters with debounce
- [ ] Binary fields auto-wrapped in SQL
- [ ] Custom mappings applied correctly
- [ ] WHERE conditions work per table
- [ ] Timezone conversion still works
- [ ] Copy to clipboard works
- [ ] Light/dark theme preserved
